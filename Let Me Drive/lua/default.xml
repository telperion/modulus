<ActorFrame><children>

	<Layer
		Type="Quad"
		InitCommand="hidden,1"
		OnCommand="sleep,1000"
	/>
	
	<Layer
		Type="Quad"
		InitCommand="hidden,1"
		OnCommand="%function(self)
				-------------------------------------------------------------
				-- Modeled pretty shamelessly after the WHY 401k structure --
				-------------------------------------------------------------
				
				fgcurcommand = 1;
				gBPM = 160.0;
				gOFF = -0.774;
				gTime = 0;
				gInitMods = false;
				--gInc = 0;
				
				gCurrentMessage = 1;
				gMessages = {
				{38.412,'Molding1'},
				{48.012,'Wiggle'},
				{76.812,'Molding2'},
				}
				
				-- Handles to graphical actors
				gHeaven = nil;
				gHeavenMuted = nil;
				gEarth = nil;
				gEarthGlow = nil;
				gPavement = {}; 		-- eventually to contain paving stones
				gSun = {};				-- eventually to contain glow rings
				gSunGradient = {};
				-- {{L-Rxx, L, L-xGB}, {R-Rxx, R, R-xGB}};
				gFrond = {{nil, nil, nil}, {nil, nil, nil}};
				gTrunk = {{nil, nil, nil}, {nil, nil, nil}};
				gGraphicsReady = false;
				gGraphicsScale = 1.0 / math.min(1280 / SCREEN_WIDTH, 960 / SCREEN_HEIGHT);
				
				-- Motion master parameters
				gMoving				= false;
				gDriving			= 0;
				gMotionEase			= 0.0;
				gMotionTaps       	= {5.0, 8.0, 13.0, 21.0, 34.0};
				gMotionTapsRecip  	= {};
				gMotionTapsPeriod 	= {};
				gMotionTapsSign 	= {};
				gMotionExtent = 0;
				for i = 1, table.getn(gMotionTaps) do
					table.insert(gMotionTapsRecip, 1, 1.0 / gMotionTaps[i]);
					table.insert(gMotionTapsPeriod, 2.0 * math.pi / gMotionTaps[i]);
					table.insert(gMotionTapsSign,   math.random(2) * 2 - 1);
					gMotionExtent = gMotionExtent + 1.0 / gMotionTaps[i];
				end	
				MotionMaster = function(t)
					motionResult = 0;
					for i = 1, table.getn(gMotionTaps) do
						motionResult = motionResult + gMotionTapsSign[i] * gMotionTapsRecip[i] * math.sin(gMotionTapsPeriod[i] * t);
					end	
					motionResult = motionResult / gMotionExtent;
					motionResultIntermediate = math.exp(2.0 * motionResult);
					motionResultBounded = (motionResultIntermediate - 1) / (motionResultIntermediate + 1);					
					return motionResultBounded;
				end;
			
				-- Beat start, Beat end, Mods, Player specific
				
				gMods = {
				
				--{0,0.700,'*10000 C0,*10000 Stealth','end'},
				{0,   40,  '2.625x,-999999% Cover,*1000 dark','end'},
				{40,  72,  '*0.1 no dark','end'},
				{272, 336, '*1000 dark','end'},
				{336, 340, '*0.3 no dark','end'},
				{272, 336, '*1000 dark','end'},
				{336, 340, '*0.3 no dark','end'},
				{344, 352, '*0.5 dark','end'},
				{352, 356, '*0.3 no dark','end'},
				{544, 560, '*1000 dark','end'},
				}
				
				gPlayers = {};
				
				self:queuecommand('Update');
			end"
		
		UpdateCommand="%function(self)
		
			-----------------------
			-- Player mod resets --
			-----------------------
			if not gInitMods then
				GAMESTATE:ApplyGameCommand('mod,clearall')
				gInitMods = true;
			end
			
			--------------------------------------------------------------------------------------------
			-- Mod reader code originally coded by TaroNuke, remade to support end times and lengths. --
			--------------------------------------------------------------------------------------------
			for i,v in pairs(gMods) do
				startSec = v[1] * 60.0 / gBPM - gOFF;
				  endSec = v[2] * 60.0 / gBPM - gOFF;				  
				 diffSec = v[2] * 60.0 / gBPM;
				if gTime >= startSec then
					if (v[4] == 'len' and gTime <= (startSec + diffSec)) or (v[4] == 'end' and gTime <= endSec) then
						if table.getn(v) == 5 then
							GAMESTATE:ApplyGameCommand('mod,'..v[3],v[5]);
						else
							GAMESTATE:ApplyGameCommand('mod,'..v[3]);
						end
					end
				end
			end
			
			-- essential for setup
 			if GAMESTATE:GetSongBeat()>=0 and fgcurcommand == 1 then	 				
 				table.insert(gPlayers,SCREENMAN:GetTopScreen():GetChild('PlayerP1'));
 				table.insert(gPlayers,SCREENMAN:GetTopScreen():GetChild('PlayerP2'));
 				fgcurcommand = fgcurcommand + 1;
 				
 				SCREENMAN:GetTopScreen():GetChild('Overlay'):hidden(1);
 				SCREENMAN:GetTopScreen():GetChild('Underlay'):hidden(1);
 				for i,v in pairs(gPlayers) do
 					if v then
 						SCREENMAN:GetTopScreen():GetChild('ScoreP'..i):hidden(1);
 						SCREENMAN:GetTopScreen():GetChild('LifeP'..i):hidden(1);
--						for k,m in pairs(getmetatable(v)) do
--							Trace('Player has field '..k..'!');
--						end
						origX = SCREEN_WIDTH * (0.5 * i - 0.25);
						v:x(SCREEN_CENTER_X);
						v:addy(SCREEN_HEIGHT / -8.0);
						v:GetChild('Judgment'):x(origX - SCREEN_CENTER_X);
						v:GetChild('Combo'):hidden(1);
						Trace('Player '..i..'\'s location is x='..v:GetX()..', y='..v:GetY()..'!');
						v:z(1);
 					end
 				end
				
				SCREENMAN:GetTopScreen():SetDrawByZPosition(true);	
 			end
			
			-- sample
			if GAMESTATE:GetSongBeat()>=190 and fgcurcommand == 12 then
				for i,v in pairs(gPlayers) do
					if v then
						
					end
				end
				fgcurcommand = fgcurcommand + 1;
			end
			
			
			gBeat = GAMESTATE:GetSongBeat();
			if gBeat >= 136 and gBeat < 144 then
				gMoving = true;
				gMotionEase = (gBeat - 136) / 8.0;
			elseif gBeat >= 144 and gBeat < 264 then
				gMoving = true;
				gMotionEase = 1.0;
			elseif gBeat >= 264 and gBeat < 272 then
				gMoving = true;
				gMotionEase = (272 - gBeat) / 8.0;
			elseif gBeat >= 272 and gBeat < 432 then
				gMoving = false;
				gMotionEase = 0.0;
				
			elseif gBeat >= 432 and gBeat < 440 then
				gMoving = true;
				gMotionEase = (gBeat - 432) / 8.0;
			elseif gBeat >= 440 and gBeat < 528 then
				gMoving = true;
				gMotionEase = 1.0;
			elseif gBeat >= 528 and gBeat < 544 then
				gMoving = true;
				gMotionEase = (gBeat - 528) / 16.0;
				gMotionEase = 1.0 - gMotionEase*gMotionEase;
			elseif gBeat >= 544 then
				gMoving = false;
				gMotionEase = 0.0;
				
			else	
--				gMoving = false;
--				gMotionEase = 0.0;
			end
			
			
			
			
			if gHeaven ~= nil and not gGraphicsReady then
				Trace('Heaven sent');
				for i,v in pairs(gSun) do
					Trace('SunGlow '..i..'!');
					v:decelerate(18 + 0.5 * i);
					v:y(SCREEN_HEIGHT * 0.9);
				end
				for i,v in pairs(gPavement) do
					Trace('PavementStone '..i..'!');
					v:y(SCREEN_HEIGHT * 0.8 + SCREEN_HEIGHT / 60.0 * (i - 0.5));
				end
				gGraphicsReady = true;		
			end
			
			
			if gGraphicsReady then
				gDriving = gDriving + 1;
				for i,v in pairs(gPavement) do
					gApparentIndex = (i + gDriving);
					gApparentIndex = gApparentIndex - math.floor(gApparentIndex/12)*12;
					v:zoomx(gGraphicsScale * (1.0 + gApparentIndex / 12.0));
					v:y(SCREEN_HEIGHT * 0.8 + SCREEN_HEIGHT / 60.0 * (gApparentIndex + 0.5));
				end
				
				
				if gMoving then
					gBeatSlow = gBeat;
					commonSway = MotionMaster(gBeatSlow);
					for i,v in pairs(gPavement) do
						gApparentIndex = (i + gDriving);
						gApparentIndex = gApparentIndex - math.floor(gApparentIndex/12)*12;
						v:x( gMotionEase * MotionMaster(gBeatSlow - gApparentIndex / 6.0) * SCREEN_WIDTH * 0.3 + SCREEN_CENTER_X );
					end			
					for i,v in pairs(gPlayers) do
						if v then
							newPlayerX = gMotionEase * commonSway * SCREEN_WIDTH * 0.3 + SCREEN_CENTER_X;
							newJCX = SCREEN_WIDTH * (0.5 * i - 0.25);
							v:x( newPlayerX );
							v:GetChild('Judgment'):x(newJCX - newPlayerX);
						end
					end
					for i,vGroup in pairs(gTrunk) do
						for j,v in pairs(vGroup) do
							v:x( gMotionEase * MotionMaster(gBeatSlow + 0.1 - j * 0.05) * SCREEN_WIDTH * 0.05 + SCREEN_WIDTH * (0.5 * i - 0.25) );
						end
					end
					for i,vGroup in pairs(gFrond) do
						for j,v in pairs(vGroup) do
							v:x( gMotionEase * MotionMaster(gBeatSlow + 0.1 - j * 0.05) * SCREEN_WIDTH * 0.05 + SCREEN_WIDTH * (0.5 * i - 0.25) );
						end
					end
				end
			end
			
			self:queuecommand('Update2');
			
		end"


		Update2Command="%function(self)
		self:sleep(1.0 / 45.0);
		self:queuecommand('Update');
		end"

		RearrangeCommand="%function(self)
			SCREENMAN:GetTopScreen():SetDrawByZPosition(true);			
			SCREENMAN:GetTopScreen():GetChild('SongBackground'):z(0);
			SCREENMAN:GetTopScreen():GetChild('SongForeground'):z(1);			
			SCREENMAN:GetTopScreen():GetChild('Overlay'):z(2);
			Trace('Just set z for TopScreen children');
			
			for i,v in pairs(gPlayers) do
				if v then
					
				end
			end
			
			if GAMESTATE:IsPlayerEnabled(0) then
			   SCREENMAN:GetTopScreen():GetChild('PlayerP1'):z(5);
			end
			if GAMESTATE:IsPlayerEnabled(1) then
			   SCREENMAN:GetTopScreen():GetChild('PlayerP2'):z(5);
			end
		end"
	/>
	
	<BitmapText
		Font="Common Normal"
		Text="test"
		OnCommand="x,SCREEN_CENTER_X;y,SCREEN_CENTER_Y;effectclock,music;playcommand,SetTime;hidden,1"
		SetTimeCommand="%function(self) self:settext(self:GetSecsIntoEffect()); gTime = tonumber(self:GetText()); self:sleep(1.0 / 45.0); self:queuecommand('SetTime'); end"
	/>
	
	
	
	
	<!-- Heaven (muted color) -->
	<Layer
		File="letmedrv-bg-muted.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.00);
			gHeavenMuted = self;
		end"
	/>
	<!-- Heaven (full color) -->
	<Layer
		File="letmedrv-bg.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.01);
			gHeaven = self;
			self:diffuse(255,255,255,0);
			self:decelerate(20);
			self:diffusealpha(1);
		end"
	/>
	
	
	<!-- Sun (glow) -->
	<Layer
		File="letmedrv-sun-glow-0.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT + self:GetHeight() / 2);
			self:z(0.021);
			self:clearzbuffer(1);
			self:blend('noeffect');
			self:zwrite(1);
			table.insert(gSun, self);
		end"
	/>
	<!-- Sun (gradient) -->
	<Layer
		File="letmedrv-sun-grad.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.022);
			self:ztestmode('writeonfail');
			table.insert(gSunGradient, self);
			self:diffuse(255,255,255,0.1);
		end"
	/>
	<!-- Sun (glow) -->
	<Layer
		File="letmedrv-sun-glow-51.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT + self:GetHeight() / 2);
			self:z(0.023);
			self:clearzbuffer(1);
			self:blend('noeffect');
			self:zwrite(1);
			table.insert(gSun, self);
		end"
	/>
	<!-- Sun (gradient) -->
	<Layer
		File="letmedrv-sun-grad.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.024);
			self:ztestmode('writeonfail');
			table.insert(gSunGradient, self);
			self:diffuse(255,255,255,0.3);
		end"
	/>
	<!-- Sun (glow) -->
	<Layer
		File="letmedrv-sun-glow-170.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT + self:GetHeight() / 2);
			self:z(0.025);
			self:clearzbuffer(1);
			self:blend('noeffect');
			self:zwrite(1);
			table.insert(gSun, self);
		end"
	/>
	<!-- Sun (gradient) -->
	<Layer
		File="letmedrv-sun-grad.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.026);
			self:ztestmode('writeonfail');
			table.insert(gSunGradient, self);
			self:diffuse(255,255,255,0.5);
		end"
	/>
	<!-- Sun (sharp) -->
	<Layer
		File="letmedrv-sun-white.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT + self:GetHeight() / 2);
			self:z(0.027);
			self:clearzbuffer(1);
			self:blend('noeffect');
			self:zwrite(1);
			table.insert(gSun, self);
		end"
	/>
	<!-- Sun (gradient) -->
	<Layer
		File="letmedrv-sun-grad.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.028);
			self:ztestmode('writeonfail');
			table.insert(gSunGradient, self);
		end"
	/>
	
	
	<!-- Trunk, L (xGB) -->
	<Layer
		File="letmedrv-trunk-L-xGB.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.25);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.03);
			self:blend('add');
			gTrunk[1][3] = self;
		end"
	/>
	<!-- Trunk, R (xGB) -->
	<Layer
		File="letmedrv-trunk-R-xGB.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.75);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.03);
			self:blend('add');
			gTrunk[2][3] = self;
		end"
	/>
	
	<!-- Trunk, L (Rxx) -->
	<Layer
		File="letmedrv-trunk-L-Rxx.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.25);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.04);
			self:blend('add');
			gTrunk[1][1] = self;
		end"
	/>
	<!-- Trunk, R (Rxx) -->
	<Layer
		File="letmedrv-trunk-R-Rxx.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.75);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.04);
			self:blend('add');
			gTrunk[2][1] = self;
		end"
	/>
	
	
	<!-- Trunk, L (sharp) -->
	<Layer
		File="letmedrv-trunk-L.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.25);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.05);
			gTrunk[1][2] = self;
		end"
	/>
	<!-- Trunk, R (sharp) -->
	<Layer
		File="letmedrv-trunk-R.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.75);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.05);
			gTrunk[2][2] = self;
		end"
	/>
	
	
	<!-- Frond, L (xGB) -->
	<Layer
		File="letmedrv-frond-L-xGB.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.25);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.03);
			self:blend('add');
			gFrond[1][3] = self;
		end"
	/>
	<!-- Frond, R (xGB) -->
	<Layer
		File="letmedrv-frond-R-xGB.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.75);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.03);
			self:blend('add');
			gFrond[2][3] = self;
		end"
	/>
	
	<!-- Frond, L (Rxx) -->
	<Layer
		File="letmedrv-frond-L-Rxx.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.25);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.04);
			self:blend('add');
			gFrond[1][1] = self;
		end"
	/>
	<!-- Frond, R (Rxx) -->
	<Layer
		File="letmedrv-frond-R-Rxx.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.75);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.04);
			self:blend('add');
			gFrond[2][1] = self;
		end"
	/>
	
	
	<!-- Frond, L (sharp) -->
	<Layer
		File="letmedrv-frond-L.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.25);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.05);
			self:diffuse(255,255,255,0.7);
			gFrond[1][2] = self;
		end"
	/>
	<!-- Frond, R (sharp) -->
	<Layer
		File="letmedrv-frond-R.png"
		OnCommand="%function(self)
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH * 0.75);
			self:y(SCREEN_HEIGHT / 2);
			self:z(0.05);
			self:diffuse(255,255,255,0.7);
			gFrond[2][2] = self;
		end"
	/>
	
	
	<!-- Earth -->
	<<Layer
		File="blacksquare.png"
		OnCommand="%function(self)
			self:stretchto(0, SCREEN_HEIGHT * 0.8, SCREEN_WIDTH, SCREEN_HEIGHT);
			self:z(1);
			gEarth = self;
		end"
	/>
	
	
	<!-- Paving stones -->
	<Layer
		File="letmedrv-road-A.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-A.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-A.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-B.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-A.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-A.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-A.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-B.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-A.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-A.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-A.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	<Layer
		File="letmedrv-road-B.png"
		OnCommand="%function(self) 
			self:zoom(gGraphicsScale);
			self:x(SCREEN_WIDTH / 2);
			self:y(SCREEN_HEIGHT);
			self:z(1.1);
			table.insert(gPavement, self);
		end"
	/>
	
	
</children></ActorFrame>